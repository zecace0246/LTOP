<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ltop.app.common.mapper.CommonComboMapper">

  <select id="selectAgencyAdminCombo" resultType="com.ltop.app.common.domain.CommonComboVO">
   /* CommonComboMapper.selectAgencyAdminCombo */
    SELECT	mem.userid AS userId
        , mem.username AS userName
    FROM  tbl_member mem, tbl_member_auth auth
    WHERE	mem.userid = auth.userid
        AND mem.enabled = 'Y'
        AND auth.auth = 'ROLE_USER'
     <if test="agencyNo != null and agencyNo != ''">
        AND mem.agency_no = ${agencyNo}
     </if>
  </select>

  <select id="selectAgencyUserCombo" resultType="com.ltop.app.common.domain.CommonComboVO">
    SELECT	mem.userid AS userId
        , mem.username AS userName
    FROM	tbl_member mem, tbl_member_auth auth
    WHERE	mem.userid = auth.userid
        AND mem.enabled = 'Y'
        AND auth.auth = 'ROLE_MEMBER'
  </select>

  <select id="selectMatCombo" resultType="com.ltop.app.common.domain.CommonComboVO">
    SELECT	mat_id AS matNo /* 실제 다른 Table은 ID로 관리*/
          , mat_id AS matId
    FROM	tbl_mat_info
    WHERE	use_yn = 'Y'

  </select>

  <select id="selectAgencyCombo" resultType="com.ltop.app.common.domain.CommonComboVO">
        SELECT  agency_no AS agencyNo
              , agency_name AS agencyName
        FROM    tbl_agency
        WHERE   use_yn = 'Y'
    </select>

    <select id="selectAgencyGroupCombo" resultType="com.ltop.app.common.domain.CommonComboVO">
        SELECT  group_seq AS groupSeq
              , group_name AS groupName
        FROM    tbl_agency_group
        WHERE   use_yn = 'Y'
        <if test="agencyNo != null and agencyNo != ''">
            AND agency_no = ${agencyNo}
        </if>
    </select>

	<select id="dashBoardv1A" resultType="com.ltop.app.common.domain.DashBoardVO">
		SELECT	ifnull(sum(case when event_num = '10001' then 1 ELSE 0 END ),0) tdayr
		       , ifnull(sum(case when event_num = '20001' then 1 ELSE 0 END ),0) tdayh
		       , 0 AS tdays
		       , ifnull(sum(case when event_num = '30001' then 1 ELSE 0 END ),0) tdayx
		       , COUNT(1) toteventcnt
		       , ifnull(sum(case when confirm_yn = 'Y' then 1 ELSE 0 END ),0) confirmcnt
		       , (
				 	SELECT	COUNT(1) cnt
					FROM		tbl_mat_info b
					WHERE		1=1
					AND		b.use_yn = 'Y'
					) totmatcnt
		       , (
		         SELECT	COUNT(1) cnt
		         FROM		(
							 	SELECT	sc.mat_id
								FROM		tbl_mat_info sb
								       , bcg sc
								WHERE		1=1
								AND		sb.use_yn = 'Y'
								AND		sb.mat_id = sc.mat_id
								AND      DATE_FORMAT(sc.reg_date, '%Y%m%d%H%i') >= DATE_FORMAT(date_add(NOW(),INTERVAL -5 minute), '%Y%m%d%H%i')
								GROUP BY sc.mat_id
								) sub
					) usecnt
		FROM   mat_alarm a
		WHERE  1=1
		AND    DATE_FORMAT(a.reg_date, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
	</select>
	<select id="dashBoardv2A" resultType="com.ltop.app.common.domain.DashBoardMVO">
		SELECT	ifnull(sum(case when event_num = '10001' then 1 ELSE 0 END ),0) tmonthr
		       , ifnull(sum(case when event_num = '20001' then 1 ELSE 0 END ),0) tmonthh
		       , 0 AS tmonths
		       , ifnull(sum(case when event_num = '30001' then 1 ELSE 0 END ),0) tmonthx
		FROM   mat_alarm a
		WHERE  1=1
		AND    DATE_FORMAT(a.reg_date, '%Y%m') = DATE_FORMAT(NOW(), '%Y%m')
	</select>

	<select id="dashBoardv1U" resultType="com.ltop.app.common.domain.DashBoardVO">
		SELECT	ifnull(sum(case when event_num = '10001' then 1 ELSE 0 END ),0) tdayr
		       , ifnull(sum(case when event_num = '20001' then 1 ELSE 0 END ),0) tdayh
		       , 0 AS tdays
		       , ifnull(sum(case when event_num = '30001' then 1 ELSE 0 END ),0) tdayx
		       , COUNT(1) toteventcnt
		       , ifnull(sum(case when confirm_yn = 'Y' then 1 ELSE 0 END ),0) confirmcnt
		       , (
				 	SELECT	COUNT(1) cnt
					FROM		tbl_mat_info a
					       , tbl_agency b
					WHERE		1=1
					AND		b.adm_id = #{userId}
					AND		a.agency_no = b.agency_no
					AND      a.use_yn = 'Y'
					AND		b.use_yn = 'Y'
					) totmatcnt
		       , (
		         SELECT	COUNT(1) cnt
		         FROM		(
							 	SELECT	c.mat_id
								FROM		tbl_mat_info a
								       , tbl_agency b
								       , bcg c
								WHERE		1=1
								AND		b.adm_id = #{userId}
								AND		a.agency_no = b.agency_no
								AND      a.use_yn = 'Y'
								AND		b.use_yn = 'Y'
								AND		a.mat_id = c.mat_id
								AND      DATE_FORMAT(c.reg_date, '%Y%m%d%H%i') >= DATE_FORMAT(date_add(NOW(),INTERVAL -5 minute), '%Y%m%d%H%i')
								GROUP BY c.mat_id
								) sub
					) usecnt
		FROM   mat_alarm a
		     , tbl_mat_info b
		     , tbl_agency c
		     , tbl_member e
		WHERE  1=1
		AND    c.adm_id = #{userId}
		AND    c.agency_no = b.agency_no
		AND    a.mat_id = b.mat_id
		AND    a.mat_id = e.mat_id
		AND    DATE_FORMAT(a.reg_date, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
	</select>
	<select id="dashBoardv2U" resultType="com.ltop.app.common.domain.DashBoardMVO">
		SELECT	ifnull(sum(case when event_num = '10001' then 1 ELSE 0 END ),0) tmonthr
		       , ifnull(sum(case when event_num = '20001' then 1 ELSE 0 END ),0) tmonthh
		       , 0 AS tmonths
		       , ifnull(sum(case when event_num = '30001' then 1 ELSE 0 END ),0) tmonthx
		FROM   mat_alarm a
		     , tbl_mat_info b
		     , tbl_agency c
		WHERE  1=1
		AND    c.adm_id = #{userId}
		AND    c.agency_no = b.agency_no
		AND    a.mat_id = b.mat_id
		AND    DATE_FORMAT(a.reg_date, '%Y%m') = DATE_FORMAT(NOW(), '%Y%m')
	</select>
	<select id="dashBoardv1P" resultType="com.ltop.app.common.domain.DashBoardVO">
		SELECT	ifnull(sum(case when event_num = '10001' then 1 ELSE 0 END ),0) AS tdayr
		       , ifnull(sum(case when event_num = '20001' then 1 ELSE 0 END ),0) AS tdayh
		       , 0 AS tdays
		       , ifnull(sum(case when event_num = '30001' then 1 ELSE 0 END ),0) AS tdayx
		       , COUNT(1) AS toteventcnt
		       , ifnull(sum(case when confirm_yn = 'Y' then 1 ELSE 0 END ),0) AS confirmcnt
		       , (
				 	SELECT	COUNT(1) cnt3
					FROM		tbl_member a
					       , tbl_mat_info b
					WHERE		1=1
					AND		a.userid = #{userId}
					AND		a.mat_id = b.mat_id
					AND		b.use_yn = 'Y'
					) AS totmatcnt
		       , (
		         SELECT	COUNT(1) cnt1
		         FROM		(
							 	SELECT	sc.mat_id
								FROM		tbl_member sa
								       , tbl_mat_info sb
								       , bcg sc
								WHERE		1=1
								AND		sa.userid = #{userId}
								AND		sa.mat_id = sb.mat_id
								AND		sb.use_yn = 'Y'
								AND		sb.mat_id = sc.mat_id
								AND      DATE_FORMAT(sc.reg_date, '%Y%m%d%H%i') >= DATE_FORMAT(date_add(NOW(),INTERVAL -5 minute), '%Y%m%d%H%i')
								GROUP BY sc.mat_id
								) sub
					) AS usecnt
		FROM   mat_alarm a
		     , tbl_member b
		WHERE  1=1
		AND    b.userid = #{userId}
		AND    a.mat_id = b.mat_id
		AND    DATE_FORMAT(a.reg_date, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
	</select>

	<select id="dashBoardv2P" resultType="com.ltop.app.common.domain.DashBoardMVO">
		SELECT	ifnull(sum(case when event_num = '10001' then 1 ELSE 0 END ),0) AS tmonthr
		       , ifnull(sum(case when event_num = '20001' then 1 ELSE 0 END ),0) AS tmonthh
		       , 0 AS tmonths
		       , ifnull(sum(case when event_num = '30001' then 1 ELSE 0 END ),0) AS tmonthx
		FROM   mat_alarm a
		     , tbl_member b
		WHERE  1=1
		AND    b.userid = #{userId}
		AND    a.mat_id = b.mat_id
		AND    DATE_FORMAT(a.reg_date, '%Y%m') = DATE_FORMAT(NOW(), '%Y%m')
	</select>

	<select id="selectAlarmListA" resultType="com.ltop.app.common.domain.AlarmVO">
		select	a.alarm_no  as alarmNo
		      , a.mat_id    as matId
		      , a.event_num as eventNum
		      , case
		      		when a.event_num='10001' then '심박이상'
		      		when a.event_num='20001' then '호흡이상'
		      		when a.event_num='30001' then '낙상감지'
		        end as eventNm
		      , a.value
		      , DATE_FORMAT(a.reg_date, '%Y-%m-%d %h:%i') as regDate
		      , a.confirm_yn as confirmYn
		      , DATE_FORMAT(a.confirm_date, '%Y-%m-%d %h:%i') as confirmDate
		      , f.username as confirmId
		      , b.agency_no  as agencyNo
		      , b.group_seq  as groupSeq
		      , c.agency_name as agencyName
		      , d.group_name as groupName
		      , e.userid as userId
		      , e.username as userName
		from	mat_alarm a
		        left outer join tbl_member f
		        on a.confirm_id = f.userid
		      , tbl_mat_info b
		        left outer join tbl_agency c
		        on b.agency_no = c.agency_no
		        left outer join tbl_agency_group d
		        on b.agency_no = c.agency_no
		        and  b.group_seq = d.group_seq
		      , tbl_member e		      
		where   1=1
		and     a.mat_id = b.mat_id
		and     a.mat_id = e.mat_id
		#AND    DATE_FORMAT(a.reg_date, '%Y%m%d%H') >= concat(DATE_FORMAT(date_add(NOW(),INTERVAL -1 DAY), '%Y%m%d'),'18')
		#AND    DATE_FORMAT(a.reg_date, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
		order by a.reg_date DESC
		limit 10
	</select>


	
	<select id="selectAlarmListU" resultType="com.ltop.app.common.domain.AlarmVO">
		select	a.alarm_no  as alarmNo
		      , a.mat_id    as matId
		      , a.event_num as eventNum
		      , case
		      		when a.event_num='10001' then '심박이상'
		      		when a.event_num='20001' then '호흡이상'
		      		when a.event_num='30001' then '낙상감지'
		        end as eventNm
		      , a.value
		      , DATE_FORMAT(a.reg_date, '%Y-%m-%d %h:%i') as regDate
		      , a.confirm_yn as confirmYn
		      , DATE_FORMAT(a.confirm_date, '%Y-%m-%d %h:%i') as confirmDate
		      , g.username as confirmId
		      , b.agency_no  as agencyNo
		      , b.group_seq  as groupSeq
		      , c.agency_name as agencyName
		      , d.group_name as groupName
		      , e.userid as userId
		      , e.username as userName
		from	mat_alarm a
		        left outer join tbl_member g
		        on a.confirm_id = g.userid
		      , tbl_mat_info b
		        left outer join tbl_agency c
		        on b.agency_no = c.agency_no
		        left outer join tbl_agency_group d
		        on b.agency_no = c.agency_no
		        and  b.group_seq = d.group_seq
		      , tbl_member e
              , tbl_agency f
		where   1=1
		and     a.mat_id = b.mat_id
		and     a.mat_id = e.mat_id
		and     f.adm_id = #{userId}
		and     b.agency_no = f.agency_no
		#AND    	DATE_FORMAT(a.reg_date, '%Y%m%d%H') >= concat(DATE_FORMAT(date_add(NOW(),INTERVAL -1 DAY), '%Y%m%d'),'18')
		#AND    	DATE_FORMAT(a.reg_date, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
		order by a.reg_date DESC
		limit 10
	</select>

	<select id="selectAlarmListP" resultType="com.ltop.app.common.domain.AlarmVO">
		select	a.alarm_no  as alarmNo
		      , a.mat_id    as matId
		      , a.event_num as eventNum
		      , case
		      		when a.event_num='10001' then '심박이상'
		      		when a.event_num='20001' then '호흡이상'
		      		when a.event_num='30001' then '낙상감지'
		        end as eventNm
		      , a.value
		      , DATE_FORMAT(a.reg_date, '%Y-%m-%d %h:%i') as regDate
		      , a.confirm_yn as confirmYn
		      , DATE_FORMAT(a.confirm_date, '%Y-%m-%d') as confirmDate
		      , f.username as confirmId
		      , b.agency_no  as agencyNo
		      , b.group_seq  as groupSeq
		      , c.agency_name as agencyName
		      , d.group_name as groupName
		      , e.userid as userId
		      , e.username as userName
		from	mat_alarm a
		        left outer join tbl_member f
		        on a.confirm_id = f.userid
		      , tbl_mat_info b
		        left outer join tbl_agency c
		        on b.agency_no = c.agency_no
		        left outer join tbl_agency_group d
		        on b.agency_no = c.agency_no
		        and  b.group_seq = d.group_seq
		      , tbl_member e
		where   1=1
		and     a.mat_id = b.mat_id
		and     a.mat_id = e.mat_id
		and     e.userid = #{userId}
		#AND    	DATE_FORMAT(a.reg_date, '%Y%m%d%H') >= concat(DATE_FORMAT(date_add(NOW(),INTERVAL -1 DAY), '%Y%m%d'),'18')
		#AND    	DATE_FORMAT(a.reg_date, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
		order by a.reg_date DESC
		limit 10
	</select>

	<select id="selectAlarmCnt" resultType="com.ltop.app.common.domain.DashBoardAVO">
		select date_format(reg_date, '%m-%d') wday
		      , ifnull(sum(case when event_num = '10001' then 1 ELSE 0 END ),0) wdayr
		      , ifnull(sum(case when event_num = '20001' then 1 ELSE 0 END ),0) wdayh
		      , 0 AS wdays
		      , ifnull(sum(case when event_num = '30001' then 1 ELSE 0 END ),0) wdayx
		from   mat_alarm
		where  1=1
		and    date_format(reg_date, '%Y-%m-%d') >= DATE_FORMAT(date_add(NOW(),INTERVAL -7 day), '%Y-%m-%d')
		group by date_format(reg_date, '%Y-%m-%d')
	</select>


	<select id="selectAlarmTotalCountA" resultType="int">
		SELECT	COUNT(*) cnt
		from	mat_alarm a
		      , tbl_mat_info b
		        left outer join tbl_agency c
		        on b.agency_no = c.agency_no
		        left outer join tbl_agency_group d
		        on b.agency_no = c.agency_no
		        and  b.group_seq = d.group_seq
		      , tbl_member e
		where   1=1
		and     a.mat_id = b.mat_id
		and     a.mat_id = e.mat_id

		<if test="searchDateFrom != null and searchDateFrom != ''">
		AND 	DATE_FORMAT(a.reg_date, '%Y-%m-%d') <![CDATA[>=]]> #{searchDateFrom}
		</if>

		<if test="searchDateTo != null and searchDateTo != ''">
		AND 	DATE_FORMAT(a.reg_date, '%Y-%m-%d') <![CDATA[<=]]> #{searchDateTo}
		</if>

		<if test="searchType != null and searchType != ''">
		AND 	a.event_num = #{searchType}
		</if>
                <if test="searchUserName != null and searchUserName != ''">
                 	AND 	e.username LIKE CONCAT('%',#{searchUserName},'%')
                </if>
                <if test="agencyNo != null and agencyNo != ''">
                 	AND 	b.agency_no = #{agencyNo}
                </if>
                <if test="groupSeq != null and groupSeq != ''">
                 	AND 	b.group_seq = #{groupSeq}
                </if>
	</select>

	<select id="selectAlarmTotalCountU" resultType="int">
		SELECT	COUNT(*)
		from	mat_alarm a
		      , tbl_mat_info b
		        left outer join tbl_agency c
		        on b.agency_no = c.agency_no
		        left outer join tbl_agency_group d
		        on b.agency_no = c.agency_no
		        and  b.group_seq = d.group_seq
		      , tbl_member e
              , tbl_agency f
		where   1=1
		and     a.mat_id = b.mat_id
		and     a.mat_id = e.mat_id
		and     f.adm_id = #{userId}
		and     b.agency_no = f.agency_no

		<if test="searchDateFrom != null and searchDateFrom != ''">
		AND 	DATE_FORMAT(a.reg_date, '%Y-%m-%d') <![CDATA[>=]]> #{searchDateFrom}
		</if>

		<if test="searchDateTo != null and searchDateTo != ''">
		AND 	DATE_FORMAT(a.reg_date, '%Y-%m-%d') <![CDATA[<=]]> #{searchDateTo}
		</if>

		<if test="searchType != null and searchType != ''">
		AND 	a.event_num = #{searchType}
		</if>
                <if test="searchUserName != null and searchUserName != ''">
                 	AND 	e.username LIKE CONCAT('%',#{searchUserName},'%')
                </if>
                <if test="agencyNo != null and agencyNo != ''">
                 	AND 	b.agency_no = #{agencyNo}
                </if>
                <if test="groupSeq != null and groupSeq != ''">
                 	AND 	b.group_seq = #{groupSeq}
                </if>		
	</select>

	<select id="selectAlarmTotalCountP" resultType="int">
		SELECT	COUNT(*)
		from	mat_alarm a
		      , tbl_mat_info b
		        left outer join tbl_agency c
		        on b.agency_no = c.agency_no
		        left outer join tbl_agency_group d
		        on b.agency_no = c.agency_no
		        and  b.group_seq = d.group_seq
		      , tbl_member e
		where   1=1
		and     a.mat_id = b.mat_id
		and     a.mat_id = e.mat_id
		and     e.userid = #{userId}

		<if test="searchDateFrom != null and searchDateFrom != ''">
		AND 	DATE_FORMAT(a.reg_date, '%Y-%m-%d') <![CDATA[>=]]> #{searchDateFrom}
		</if>

		<if test="searchDateTo != null and searchDateTo != ''">
		AND 	DATE_FORMAT(a.reg_date, '%Y-%m-%d') <![CDATA[<=]]> #{searchDateTo}
		</if>

		<if test="searchType != null and searchType != ''">
		AND 	a.event_num = #{searchType}
		</if>
                <if test="searchUserName != null and searchUserName != ''">
                 	AND 	e.username LIKE CONCAT('%',#{searchUserName},'%')
                </if>
                <if test="agencyNo != null and agencyNo != ''">
                 	AND 	b.agency_no = #{agencyNo}
                </if>
                <if test="groupSeq != null and groupSeq != ''">
                 	AND 	b.group_seq = #{groupSeq}
                </if>
	</select>

	<select id="selectMenuAlarmListA" resultType="com.ltop.app.common.domain.AlarmVO">
		<![CDATA[
			SELECT R.*
			FROM
			(
				select	a.alarm_no  as alarmNo
				      , a.mat_id    as matId
				      , a.event_num as eventNum
				      , case
				      		when a.event_num='10001' then '심박이상'
				      		when a.event_num='20001' then '호흡이상'
				      		when a.event_num='30001' then '낙상감지'
				        end as eventNm
				      , a.value
				      , DATE_FORMAT(a.reg_date, '%Y-%m-%d %h:%i') as regDate
				      , a.confirm_yn as confirmYn
				      , DATE_FORMAT(a.confirm_date, '%Y-%m-%d %h:%i') as confirmDate
				      , f.username as confirmId
				      , b.agency_no  as agencyNo
				      , b.group_seq  as groupSeq
				      , c.agency_name as agencyName
				      , d.group_name as groupName
				      , e.userid as userId
				      , e.username as userName
				from	mat_alarm a
				        left outer join tbl_member f
				        on a.confirm_id = f.userid
				      , tbl_mat_info b
				        left outer join tbl_agency c
				        on b.agency_no = c.agency_no
				        left outer join tbl_agency_group d
				        on b.agency_no = c.agency_no
				        and  b.group_seq = d.group_seq
				      , tbl_member e
				where   1=1
				and     a.mat_id = b.mat_id
				and     a.mat_id = e.mat_id
		]]>
				<if test="alarmVO.searchDateFrom != null and alarmVO.searchDateFrom != ''">
				AND 	DATE_FORMAT(a.reg_date, '%Y-%m-%d') <![CDATA[>=]]> #{alarmVO.searchDateFrom}
				</if>

				<if test="alarmVO.searchDateTo != null and alarmVO.searchDateTo != ''">
				AND 	DATE_FORMAT(a.reg_date, '%Y-%m-%d') <![CDATA[<=]]> #{alarmVO.searchDateTo}
				</if>

				<if test="alarmVO.searchType != null and alarmVO.searchType != ''">
				AND 	a.event_num = #{alarmVO.searchType}
				</if>
                <if test="alarmVO.searchUserName != null and alarmVO.searchUserName != ''">
                 	AND 	e.username LIKE CONCAT('%',#{alarmVO.searchUserName},'%')
                </if>
                <if test="alarmVO.agencyNo != null and alarmVO.agencyNo != ''">
                 	AND 	b.agency_no = #{alarmVO.agencyNo}
                </if>
                <if test="alarmVO.groupSeq != null and alarmVO.groupSeq != ''">
                 	AND 	b.group_seq = #{alarmVO.groupSeq}
                </if>
		<![CDATA[
			) R
			ORDER BY R.alarmNo DESC
			LIMIT #{pageVO.amount} OFFSET #{pageVO.startNum}
		]]>
	</select>

	<select id="selectMenuAlarmListU" resultType="com.ltop.app.common.domain.AlarmVO">
		<![CDATA[
			SELECT R.*
			FROM
			(
				select	a.alarm_no  as alarmNo
				      , a.mat_id    as matId
				      , a.event_num as eventNum
				      , case
				      		when a.event_num='10001' then '심박이상'
				      		when a.event_num='20001' then '호흡이상'
				      		when a.event_num='30001' then '낙상감지'
				        end as eventNm
				      , a.value
				      , DATE_FORMAT(a.reg_date, '%Y-%m-%d %h:%i') as regDate
				      , a.confirm_yn as confirmYn
				      , DATE_FORMAT(a.confirm_date, '%Y-%m-%d %h:%i') as confirmDate
				      , g.username as confirmId
				      , b.agency_no  as agencyNo
				      , b.group_seq  as groupSeq
				      , c.agency_name as agencyName
				      , d.group_name as groupName
				      , e.userid as userId
				      , e.username as userName
				from	mat_alarm a
				        left outer join tbl_member g
				        on a.confirm_id = g.userid
				      , tbl_mat_info b
				        left outer join tbl_agency c
				        on b.agency_no = c.agency_no
				        left outer join tbl_agency_group d
				        on b.agency_no = c.agency_no
				        and  b.group_seq = d.group_seq
				      , tbl_member e
		              , tbl_agency f
				where   1=1
				and     a.mat_id = b.mat_id
				and     a.mat_id = e.mat_id
				and     f.adm_id = #{alarmVO.userId}
				and     b.agency_no = f.agency_no
		]]>
				<if test="alarmVO.searchDateFrom != null and alarmVO.searchDateFrom != ''">
				AND 	DATE_FORMAT(a.reg_date, '%Y-%m-%d') <![CDATA[>=]]> #{alarmVO.searchDateFrom}
				</if>

				<if test="alarmVO.searchDateTo != null and alarmVO.searchDateTo != ''">
				AND 	DATE_FORMAT(a.reg_date, '%Y-%m-%d') <![CDATA[<=]]> #{alarmVO.searchDateTo}
				</if>

				<if test="alarmVO.searchType != null and alarmVO.searchType != ''">
				AND 	a.event_num = #{alarmVO.searchType}
				</if>
                <if test="alarmVO.searchUserName != null and alarmVO.searchUserName != ''">
                 	AND 	e.username LIKE CONCAT('%',#{alarmVO.searchUserName},'%')
                </if>
                <if test="alarmVO.agencyNo != null and alarmVO.agencyNo != ''">
                 	AND 	b.agency_no = #{alarmVO.agencyNo}
                </if>
                <if test="alarmVO.groupSeq != null and alarmVO.groupSeq != ''">
                 	AND 	b.group_seq = #{alarmVO.groupSeq}
                </if>
		<![CDATA[
			) R
			ORDER BY R.alarmNo DESC
			LIMIT #{pageVO.amount} OFFSET #{pageVO.startNum}
		]]>
	</select>

	<select id="selectMenuAlarmListP" resultType="com.ltop.app.common.domain.AlarmVO">
		<![CDATA[
			SELECT R.*
			FROM
			(
				select	a.alarm_no  as alarmNo
				      , a.mat_id    as matId
				      , a.event_num as eventNum
				      , case
				      		when a.event_num='10001' then '심박이상'
				      		when a.event_num='20001' then '호흡이상'
				      		when a.event_num='30001' then '낙상감지'
				        end as eventNm
				      , a.value
				      , DATE_FORMAT(a.reg_date, '%Y-%m-%d %h:%i') as regDate
				      , a.confirm_yn as confirmYn
				      , DATE_FORMAT(a.confirm_date, '%Y-%m-%d %h:%i') as confirmDate
				      , f.username as confirmId
				      , b.agency_no  as agencyNo
				      , b.group_seq  as groupSeq
				      , c.agency_name as agencyName
				      , d.group_name as groupName
				      , e.userid as userId
				      , e.username as userName
				from	mat_alarm a
				        left outer join tbl_member f
				        on a.confirm_id = f.userid
				      , tbl_mat_info b
				        left outer join tbl_agency c
				        on b.agency_no = c.agency_no
				        left outer join tbl_agency_group d
				        on b.agency_no = c.agency_no
				        and  b.group_seq = d.group_seq
				      , tbl_member e
				where   1=1
				and     a.mat_id = b.mat_id
				and     a.mat_id = e.mat_id
				and     e.userid = #{alarmVO.userId}
		]]>
				<if test="alarmVO.searchDateFrom != null and alarmVO.searchDateFrom != ''">
				AND 	DATE_FORMAT(a.reg_date, '%Y-%m-%d') <![CDATA[>=]]> #{alarmVO.searchDateFrom}
				</if>

				<if test="alarmVO.searchDateTo != null and alarmVO.searchDateTo != ''">
				AND 	DATE_FORMAT(a.reg_date, '%Y-%m-%d') <![CDATA[<=]]> #{alarmVO.searchDateTo}
				</if>

				<if test="alarmVO.searchType != null and alarmVO.searchType != ''">
				AND 	a.event_num = #{alarmVO.searchType}
				</if>
                <if test="alarmVO.searchUserName != null and alarmVO.searchUserName != ''">
                 	AND 	e.username LIKE CONCAT('%',#{alarmVO.searchUserName},'%')
                </if>
                <if test="alarmVO.agencyNo != null and alarmVO.agencyNo != ''">
                 	AND 	b.agency_no = #{alarmVO.agencyNo}
                </if>
                <if test="alarmVO.groupSeq != null and alarmVO.groupSeq != ''">
                 	AND 	b.group_seq = #{alarmVO.groupSeq}
                </if>
		<![CDATA[
			) R
			ORDER BY R.alarmNo DESC
			LIMIT #{pageVO.amount} OFFSET #{pageVO.startNum}
		]]>
	</select>

	<select id="selectUserTotalCountA" resultType="int">
		SELECT		COUNT(*) cnt
		FROM		(
					SELECT	c.userid, c.username, c.mat_id, c.agency_no, d.group_name
					FROM		tbl_mat_info b
					         left outer join tbl_agency_group d
					         on b.group_seq = d.group_seq
					       , tbl_member c
					WHERE    1=1
					AND      b.use_yn = 'Y'
					AND      b.mat_id = c.mat_id
                <if test="searchUserName != null and searchUserName != ''">
                 	AND 	c.username LIKE CONCAT('%',#{searchUserName},'%')
                </if>
                <if test="agencyNo != null and agencyNo != ''">
                 	AND 	b.agency_no = #{agencyNo}
                </if>
                <if test="groupSeq != null and groupSeq != ''">
                 	AND 	b.group_seq = #{groupSeq}
                </if>
					) a
					LEFT OUTER JOIN (	SELECT	a.*
											FROM		bcg a
							      				, (
														SELECT  mat_id, MAX(bno) bno
														FROM   bcg a
														WHERE   1=1
														AND  DATE_FORMAT(a.reg_date, '%Y%m%d%H%i') >= DATE_FORMAT(date_add(NOW(),INTERVAL -5 minute), '%Y%m%d%H%i')
														GROUP BY mat_id
														) b
											WHERE    1=1
											AND      a.mat_id = b.mat_id
											AND      a.bno = b.bno
										  ) b
		      	ON	a.mat_id = b.mat_id
		       LEFT OUTER join tbl_agency c
		       ON	a.agency_no = c.agency_no
	</select>

	<select id="selectUserTotalCountU" resultType="int">
		SELECT		COUNT(*) cnt
		FROM		(
					SELECT	c.userid, c.username, c.mat_id, c.agency_no, d.group_name
					FROM		tbl_agency a
					       , tbl_mat_info b
					         left outer join tbl_agency_group d
					         on b.group_seq = d.group_seq
					       , tbl_member c
					WHERE    1=1
					AND      a.adm_id = #{userId}
					AND      a.agency_no = b.agency_no
					AND      a.use_yn = 'Y'
					AND      b.use_yn = 'Y'
					AND      b.mat_id = c.mat_id
                <if test="searchUserName != null and searchUserName != ''">
                 	AND 	c.username LIKE CONCAT('%',#{searchUserName},'%')
                </if>
                <if test="agencyNo != null and agencyNo != ''">
                 	AND 	b.agency_no = #{agencyNo}
                </if>
                <if test="groupSeq != null and groupSeq != ''">
                 	AND 	b.group_seq = #{groupSeq}
                </if>
					) a
					LEFT OUTER JOIN (	SELECT	a.*
											FROM		bcg a
							      				, (
														SELECT  mat_id, MAX(bno) bno
														FROM   bcg a
														WHERE   1=1
														AND  DATE_FORMAT(a.reg_date, '%Y%m%d%H%i') >= DATE_FORMAT(date_add(NOW(),INTERVAL -5 minute), '%Y%m%d%H%i')
														GROUP BY mat_id
														) b
											WHERE    1=1
											AND      a.mat_id = b.mat_id
											AND      a.bno = b.bno
										  ) b
		      	ON	a.mat_id = b.mat_id
		       LEFT OUTER join tbl_agency c
		       ON	a.agency_no = c.agency_no
	</select>

	<select id="selectUserTotalCountP" resultType="int">
		SELECT		COUNT(*) cnt
		FROM   tbl_member a
		       LEFT OUTER join bcg b
		       ON	a.mat_id = b.mat_id
		       AND  DATE_FORMAT(b.reg_date, '%Y%m%d%H%i') >= DATE_FORMAT(date_add(NOW(),INTERVAL -5 minute), '%Y%m%d%H%i')
		       LEFT OUTER join tbl_agency c
		       ON	a.agency_no = c.agency_no
		     , tbl_mat_info d
		       left outer join tbl_agency_group e
		       on  d.group_seq = e.group_seq
		WHERE  1=1
		and	   a.userid = #{userId}
		and    a.mat_id = d.mat_id
		ORDER BY b.reg_date desc
		LIMIT 1
	</select>

	<select id="selectMenuUserListA" resultType="com.ltop.app.common.domain.UserVO">
		<![CDATA[
			SELECT R.*
			FROM
			(
				SELECT a.userid
				      , a.username
				      , c.agency_name AS agencyName
				      , a.group_name AS groupName
						, b.mat_id  AS matId
						, b.respiration_rate  AS respirationRate
						, b.heart_rate AS heartRate
						, b.sleep_mode  AS sleepMode
				       , ( select case when count(1) > 0 then '낙상감지' else '감시중' end from mat_alarm ta where 1=1 and ta.event_num='30001'  and ta.mat_id = b.mat_id  AND    DATE_FORMAT(ta.reg_date, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d') ) fallAlarm
				       , a.reg_date AS regDate
				FROM		(
							SELECT	c.userid, c.username, c.mat_id, c.agency_no, d.group_name, DATE_FORMAT(b.reg_date, '%Y-%m-%d') reg_date
							FROM		tbl_mat_info b
							         left outer join tbl_agency_group d
							         on b.group_seq = d.group_seq
							       , tbl_member c
							WHERE    1=1
							AND      b.use_yn = 'Y'
							AND      b.mat_id = c.mat_id
		]]>
                <if test="alarmVO.searchUserName != null and alarmVO.searchUserName != ''">
                 	AND 	c.username LIKE CONCAT('%',#{alarmVO.searchUserName},'%')
                </if>
                <if test="alarmVO.agencyNo != null and alarmVO.agencyNo != ''">
                 	AND 	b.agency_no = #{alarmVO.agencyNo}
                </if>
                <if test="alarmVO.groupSeq != null and alarmVO.groupSeq != ''">
                 	AND 	b.group_seq = #{alarmVO.groupSeq}
                </if>
		<![CDATA[
							) a
							LEFT OUTER JOIN (	SELECT	a.*
													FROM		bcg a
									      				, (
																SELECT  mat_id, MAX(bno) bno
																FROM   bcg a
																WHERE   1=1
																AND  DATE_FORMAT(a.reg_date, '%Y%m%d%H%i') >= DATE_FORMAT(date_add(NOW(),INTERVAL -5 minute), '%Y%m%d%H%i')
																GROUP BY mat_id
																) b
													WHERE    1=1
													AND      a.mat_id = b.mat_id
													AND      a.bno = b.bno
												  ) b
				      	ON	a.mat_id = b.mat_id
				       LEFT OUTER join tbl_agency c
				       ON	a.agency_no = c.agency_no
		]]>

		<![CDATA[
			) R
			ORDER BY R.agencyName, R.groupName ASC
			LIMIT #{pageVO.amount} OFFSET #{pageVO.startNum}
		]]>
	</select>

	<select id="selectMenuUserListU" resultType="com.ltop.app.common.domain.UserVO">
		<![CDATA[
			SELECT R.*
			FROM
			(
				SELECT a.userid
				      , a.username
				      , c.agency_name AS agencyName
				      , a.group_name AS groupName
						, b.mat_id AS matId
						, b.respiration_rate AS respirationRate
						, b.heart_rate AS heartRate
						, b.sleep_mode  AS sleepMode
				      , ( select case when count(1) > 0 then '낙상감지' else '감시중' end from mat_alarm ta where 1=1 and ta.event_num='30001'  and ta.mat_id = b.mat_id  AND    DATE_FORMAT(ta.reg_date, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d') ) fallAlarm
				      , a.reg_date AS regDate
				FROM		(
							SELECT	c.userid, c.username, c.mat_id, c.agency_no, d.group_name, DATE_FORMAT(b.reg_date, '%Y-%m-%d') reg_date
							FROM		tbl_agency a
							       , tbl_mat_info b
							         left outer join tbl_agency_group d
							         on b.group_seq = d.group_seq
							       , tbl_member c
							WHERE    1=1
							AND      a.adm_id =#{alarmVO.userId}
							AND      a.agency_no = b.agency_no
							AND      a.use_yn = 'Y'
							AND      b.use_yn = 'Y'
							AND      b.mat_id = c.mat_id
		]]>
                <if test="alarmVO.searchUserName != null and alarmVO.searchUserName != ''">
                 	AND 	c.username LIKE CONCAT('%',#{alarmVO.searchUserName},'%')
                </if>
                <if test="alarmVO.agencyNo != null and alarmVO.agencyNo != ''">
                 	AND 	b.agency_no = #{alarmVO.agencyNo}
                </if>
                <if test="alarmVO.groupSeq != null and alarmVO.groupSeq != ''">
                 	AND 	b.group_seq = #{alarmVO.groupSeq}
                </if>
		<![CDATA[
							) a
							LEFT OUTER JOIN (	SELECT	a.*
													FROM		bcg a
									      				, (
																SELECT  mat_id, MAX(bno) bno
																FROM   bcg a
																WHERE   1=1
																AND  DATE_FORMAT(a.reg_date, '%Y%m%d%H%i') >= DATE_FORMAT(date_add(NOW(),INTERVAL -5 minute), '%Y%m%d%H%i')
																GROUP BY mat_id
																) b
													WHERE    1=1
													AND      a.mat_id = b.mat_id
													AND      a.bno = b.bno
												  ) b
				      	ON	a.mat_id = b.mat_id
				       LEFT OUTER join tbl_agency c
				       ON	a.agency_no = c.agency_no
		]]>

		<![CDATA[
			) R
			ORDER BY R.agencyName, R.groupName ASC
			LIMIT #{pageVO.amount} OFFSET #{pageVO.startNum}
		]]>
	</select>

	<select id="selectMenuUserListP" resultType="com.ltop.app.common.domain.UserVO">
		<![CDATA[
			SELECT R.*
			FROM
			(
				SELECT a.userid
				      , a.username
				      , c.agency_name AS agencyName
				      , e.group_name AS groupName
				      , b.mat_id AS matId
						, b.respiration_rate AS respirationRate
						, b.heart_rate AS heartRate
						, b.sleep_mode  AS sleepMode
					  , ( select case when count(1) > 0 then '낙상감지' else '감시중' end from mat_alarm ta where 1=1 and ta.event_num='30001'  and ta.mat_id = b.mat_id  AND    DATE_FORMAT(ta.reg_date, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d') ) fallAlarm
					  , DATE_FORMAT(d.reg_date, '%Y-%m-%d') AS regDate
				FROM   tbl_member a
				       LEFT OUTER join bcg b
				       ON	a.mat_id = b.mat_id
				       AND  DATE_FORMAT(b.reg_date, '%Y%m%d%H%i') >= DATE_FORMAT(date_add(NOW(),INTERVAL -5 minute), '%Y%m%d%H%i')
				       LEFT OUTER join tbl_agency c
				       ON	a.agency_no = c.agency_no
				     , tbl_mat_info d
				       left outer join tbl_agency_group e
				       on  d.group_seq = e.group_seq
				WHERE  1=1
				and	   a.userid = #{alarmVO.userId}
				and    a.mat_id = d.mat_id
				ORDER BY b.reg_date desc
				LIMIT 1
		]]>

		<![CDATA[
			) R
			ORDER BY R.agencyName, R.groupName ASC
			LIMIT #{pageVO.amount} OFFSET #{pageVO.startNum}
		]]>
	</select>

    <select id="selectUserTodayInfo" resultType="com.ltop.app.common.domain.UserVO">
		select  ifnull(max(a.respiration_rate),0) as respirationRateMax
		      , ifnull(min(a.respiration_rate),0) as respirationRateMin
		      , ifnull(max(a.heart_rate ),0) as heartRateMax
		      , ifnull(min(a.heart_rate ),0) as heartRateMin
		      , ifnull(max(a.sleep_mode ),0) as sleepModeMax
		      , ifnull(min(a.sleep_mode ),0) as sleepModeMin
			  , c.respiration_rate  AS respirationRate
		  	  , c.heart_rate        AS heartRate
			  , c.sleep_mode        AS sleepMode
			  , b.position_time     AS positionTime
			  , b.position_update   AS positionUpdate
			  , case when c.reg_date is null then '미사용'
			         else timediff( now() , b.position_update )
			    end positionCurrent
			  , b.username   AS userName
			  , d.sleep_grade as sleepGrade
		from	bcg a 
		      , tbl_member b
				LEFT OUTER JOIN (	SELECT	a.*
										FROM		bcg a
						      				, (
													SELECT  mat_id, MAX(bno) bno
													FROM   bcg a
													WHERE   1=1
													AND  DATE_FORMAT(a.reg_date, '%Y%m%d%H%i') >= DATE_FORMAT(date_add(NOW(),INTERVAL -5 minute), '%Y%m%d%H%i')
													GROUP BY mat_id
													) b
										WHERE    1=1
										AND      a.mat_id = b.mat_id
										AND      a.bno = b.bno
									  ) c
		  		ON	b.mat_id = c.mat_id
		  		left outer join (
									select case when sleep_rem <![CDATA[<]]> 5 then 'D'
									            when sleep_rem <![CDATA[>=]]> 5 and sleep_rem <![CDATA[<]]> 15 then 'C'
									            when sleep_rem <![CDATA[>=]]> 15 and sleep_rem <![CDATA[<]]> 25 then 'B'
									            when sleep_rem <![CDATA[>=]]> 25  then 'A'
								           end sleep_grade
								         , mat_id
									from (
										select mat_id, round(sum(case when sleep_mode = '1' then 1 ELSE 0 END )/count(1)*100,0) sleep_rem
										from bcg
										where 1=1
										and    DATE_FORMAT(reg_date, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
										group by mat_id
										) main
		  		                ) d
		  		ON	b.mat_id = d.mat_id
		where	1=1
		and    	b.userid = #{userId}
		and    	a.mat_id = b.mat_id
		AND    DATE_FORMAT(a.reg_date, '%Y%m%d%H') <![CDATA[>=]]> case when b.sleep_time = NULL OR b.sleep_time ='' 
				                                                   then concat(DATE_FORMAT(NOW(), '%Y%m%d'),'00')
				                                                   ELSE concat(DATE_FORMAT(date_add(NOW(),INTERVAL -1 DAY), '%Y%m%d'),b.sleep_time)
				                                              end
		AND    DATE_FORMAT(a.reg_date, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
    </select>

    <select id="selectUserTodayBcg" resultType="com.ltop.app.common.domain.BcgVO">
		select  round(avg(a.respiration_rate)) as respirationRate
		      , min(a.respiration_rate) as respirationRateMin
		      , max(a.respiration_rate) as respirationRateMax
		      , round(avg(a.heart_rate)) as heartRate
		      , min(a.heart_rate) as heartRateMin
		      , max(a.heart_rate) as heartRateMax
		      , round(avg(a.sleep_mode)) as sleepMode
		<if test="searchType != null and searchType == 'HOUR'">
		      , DATE_FORMAT(a.reg_date, '%h') as regDate
		</if>
		<if test="searchType != null and searchType == 'DAY'">
			  , DATE_FORMAT(a.reg_date, '%m-%d') as regDate
		</if>
		from	bcg a 
		      , tbl_member b
		where	1=1
		and    	b.userid = #{userId}
		and    	a.mat_id = b.mat_id
		<if test="searchType != null and searchType == 'HOUR'">
		AND    DATE_FORMAT(a.reg_date, '%Y%m%d%H') <![CDATA[>=]]> case when b.sleep_time = NULL OR b.sleep_time ='' 
				                                                   then concat(DATE_FORMAT(NOW(), '%Y%m%d'),'00')
				                                                   ELSE concat(DATE_FORMAT(date_add(NOW(),INTERVAL -1 DAY), '%Y%m%d'),b.sleep_time)
				                                              end
		AND    DATE_FORMAT(a.reg_date, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
		group by DATE_FORMAT(a.reg_date, '%Y-%m-%d %h')
		</if>
		<if test="searchType != null and searchType == 'DAY'">
		AND    DATE_FORMAT(a.reg_date, '%Y%m%d') <![CDATA[>=]]> DATE_FORMAT(date_add(NOW(),INTERVAL -7 DAY), '%Y%m%d')
		group by DATE_FORMAT(a.reg_date, '%Y-%m-%d')
		</if>
    </select>
    
    <select id="selectUserSleepList" resultType="com.ltop.app.common.domain.BcgVO">
		select	a.mat_id 		as matId
		      , a.sleep_mode 	as sleepMode
		      , DATE_FORMAT(a.reg_date, '%Y-%m-%d %h:%i') as regDate
		from	bcg a
			  , tbl_member b
		where	1=1
		and    	b.userid = #{userId}
		and    	a.mat_id = b.mat_id
		and    DATE_FORMAT(reg_date, '%Y%m%d') = #{searchDay}
    </select>

    <select id="userPositionHist" resultType="com.ltop.app.common.domain.UserVO">
		select	a.userid 		as userId
		      , a.position_type 	as positionType
		      , DATE_FORMAT(a.reg_date, '%Y-%m-%d %h:%i') as regDate
		      , b.username
		from	tbl_position_hist a
			  , tbl_member b
		where	1=1
		and    	a.userid = #{userId}
		and    	a.userid = b.userid
		and    DATE_FORMAT(reg_date, '%Y%m%d') = #{searchDay}
    </select>
    
    <select id="selectUserTodayAlarm" resultType="com.ltop.app.common.domain.AlarmVO">
				select	a.alarm_no  as alarmNo
				      , a.mat_id    as matId
				      , a.event_num as eventNum
				      , case
				      		when a.event_num='10001' then '심박이상'
				      		when a.event_num='20001' then '호흡이상'
				      		when a.event_num='30001' then '낙상감지'
				        end as eventNm
				      , a.value
				      , DATE_FORMAT(a.reg_date, '%Y-%m-%d %h:%i') as regDate
				      , a.confirm_yn as confirmYn
				      , DATE_FORMAT(a.confirm_date, '%Y-%m-%d %h:%i') as confirmDate
				      , f.username as confirmId
				      , b.agency_no  as agencyNo
				      , b.group_seq  as groupSeq
				      , c.agency_name as agencyName
				      , d.group_name as groupName
				      , e.userid as userId
				      , e.username as userName
				from	mat_alarm a
						left outer join tbl_member f
		        		on a.confirm_id = f.userid
				      , tbl_mat_info b
				        left outer join tbl_agency c
				        on b.agency_no = c.agency_no
				        left outer join tbl_agency_group d
				        on b.agency_no = c.agency_no
				        and  b.group_seq = d.group_seq
				      , tbl_member e
				where   1=1
				and     a.mat_id = b.mat_id
				and     a.mat_id = e.mat_id
				and     e.userid = #{userId}
				AND    DATE_FORMAT(a.reg_date, '%Y%m%d%H') <![CDATA[>=]]> case when e.sleep_time = NULL OR e.sleep_time ='' 
						                                                   then concat(DATE_FORMAT(NOW(), '%Y%m%d'),'00')
						                                                   ELSE concat(DATE_FORMAT(date_add(NOW(),INTERVAL -1 DAY), '%Y%m%d'),e.sleep_time)
						                                              end
				AND    DATE_FORMAT(a.reg_date, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
				order by a.reg_date desc
    </select>
    <select id="selectTodaySleep" resultType="com.ltop.app.common.domain.UserVO">
		select	case when sleep_rem <![CDATA[<]]> 5 then 'D'
		            when sleep_rem <![CDATA[>=]]> 5 and sleep_rem <![CDATA[<]]> 15 then 'C'
		            when sleep_rem <![CDATA[>=]]> 15 and sleep_rem <![CDATA[<]]> 25 then 'B'
		            when sleep_rem <![CDATA[>=]]> 25  then 'A'
	           	end as sleepGrade
	          , sleep_rem 	as sleepRem
	          , sleep_1_cnt as sleepCnt1
	          , sleep_2_cnt as sleepCnt2
	          , sleep_3_cnt as sleepCnt3
	          , sleep_4_cnt as sleepCnt4
	          , snore_cnt 	as snoreCnt
	          , apnea_cnt 	as apneaCnt
	          , tot_cnt 	as totCnt
		from	(
				select	round(sum(case when sleep_mode = '1' then 1 ELSE 0 END )/count(1)*100,0) sleep_rem
	 		     	  , sum(case when sleep_mode = '1' then 1 ELSE 0 END ) sleep_1_cnt
	 		     	  , sum(case when sleep_mode = '2' then 1 ELSE 0 END ) sleep_2_cnt
	 		     	  , sum(case when sleep_mode = '3' then 1 ELSE 0 END ) sleep_3_cnt
	 		     	  , sum(case when sleep_mode = '4' then 1 ELSE 0 END ) sleep_4_cnt
	 		     	  , sum(case when snore_yn = 'Y' then 1 ELSE 0 END ) snore_cnt
	 		     	  , sum(case when apnea_yn = 'Y' then 1 ELSE 0 END ) apnea_cnt
	 		     	  , count(1) tot_cnt
				from	bcg a
			      	  , tbl_member b
				where	1=1
				and    	b.userid = #{userId}
				and    	a.mat_id = b.mat_id
				and    DATE_FORMAT(reg_date, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
				) main
    </select>

    <select id="selectUserSleepInfo" resultType="com.ltop.app.common.domain.UserVO">
		select	case when sleep_rem <![CDATA[<]]> 5 then 'D'
		            when sleep_rem <![CDATA[>=]]> 5 and sleep_rem <![CDATA[<]]> 15 then 'C'
		            when sleep_rem <![CDATA[>=]]> 15 and sleep_rem <![CDATA[<]]> 25 then 'B'
		            when sleep_rem <![CDATA[>=]]> 25  then 'A'
	           	end as sleepGrade
	          , sleep_rem 	as sleepRem
	          , sleep_1_cnt as sleepCnt1
	          , sleep_2_cnt as sleepCnt2
	          , sleep_3_cnt as sleepCnt3
	          , sleep_4_cnt as sleepCnt4
	          , snore_cnt 	as snoreCnt
	          , apnea_cnt 	as apneaCnt
	          , tot_cnt 	as totCnt
		from	(
				select	round(sum(case when sleep_mode = '1' then 1 ELSE 0 END )/count(1)*100,0) sleep_rem
	 		     	  , sum(case when sleep_mode = '1' then 1 ELSE 0 END ) sleep_1_cnt
	 		     	  , sum(case when sleep_mode = '2' then 1 ELSE 0 END ) sleep_2_cnt
	 		     	  , sum(case when sleep_mode = '3' then 1 ELSE 0 END ) sleep_3_cnt
	 		     	  , sum(case when sleep_mode = '4' then 1 ELSE 0 END ) sleep_4_cnt
	 		     	  , sum(case when snore_yn = 'Y' then 1 ELSE 0 END ) snore_cnt
	 		     	  , sum(case when apnea_yn = 'Y' then 1 ELSE 0 END ) apnea_cnt
	 		     	  , count(1) tot_cnt
				from	bcg a
			      	  , tbl_member b
				where	1=1
				and    	b.userid = #{userId}
				and    	a.mat_id = b.mat_id
				and    DATE_FORMAT(reg_date, '%Y%m%d') = #{searchDay}
				) main
    </select>
    
  <update id="alarmUpdate">
    UPDATE	mat_alarm
       SET confirm_yn = 'Y'
        , confirm_date = now()
        , confirm_id = #{userId}
        , confirm_type = #{confirmType}
    WHERE alarm_no = #{alarmNo}
  </update>

  <update id="positionUpdate">
    UPDATE	tbl_member
       SET position_update = now()
         , position_type = #{positionType}
    WHERE userid = #{userId}
  </update>
    <insert id="positionInsert">
    INSERT INTO tbl_position_hist
    (
      userid
      , position_type
      , reg_date
    )
    VALUES
    (
      #{userId}
      , #{positionType}
      , now()
    )
  </insert>
  
	<select id="selectSummaryTotalCountA" resultType="int">
		SELECT		COUNT(*) cnt
		FROM		(
					SELECT	c.userid, c.username, c.mat_id, c.agency_no, d.group_name
					FROM		tbl_mat_info b
					         left outer join tbl_agency_group d
					         on b.group_seq = d.group_seq
					       , tbl_member c
					WHERE    1=1
					AND      b.use_yn = 'Y'
					AND      b.mat_id = c.mat_id
                <if test="searchUserName != null and searchUserName != ''">
                 	AND 	c.username LIKE CONCAT('%',#{searchUserName},'%')
                </if>
                <if test="agencyNo != null and agencyNo != ''">
                 	AND 	b.agency_no = #{agencyNo}
                </if>
                <if test="groupSeq != null and groupSeq != ''">
                 	AND 	b.group_seq = #{groupSeq}
                </if>
					) a
					LEFT OUTER JOIN (	SELECT	a.*
											FROM		bcg a
							      				, (
														SELECT  mat_id, MAX(bno) bno
														FROM   bcg a
														WHERE   1=1
														AND  DATE_FORMAT(a.reg_date, '%Y%m%d%H%i') >= DATE_FORMAT(date_add(NOW(),INTERVAL -5 minute), '%Y%m%d%H%i')
														GROUP BY mat_id
														) b
											WHERE    1=1
											AND      a.mat_id = b.mat_id
											AND      a.bno = b.bno
										  ) b
		      	ON	a.mat_id = b.mat_id
		       LEFT OUTER join tbl_agency c
		       ON	a.agency_no = c.agency_no
	</select>

	<select id="selectSummaryTotalCountU" resultType="int">
		SELECT		COUNT(*) cnt
		FROM		(
					SELECT	c.userid, c.username, c.mat_id, c.agency_no, d.group_name
					FROM		tbl_agency a
					       , tbl_mat_info b
					         left outer join tbl_agency_group d
					         on b.group_seq = d.group_seq
					       , tbl_member c
					WHERE    1=1
					AND      a.adm_id = #{userId}
					AND      a.agency_no = b.agency_no
					AND      a.use_yn = 'Y'
					AND      b.use_yn = 'Y'
					AND      b.mat_id = c.mat_id
                <if test="searchUserName != null and searchUserName != ''">
                 	AND 	c.username LIKE CONCAT('%',#{searchUserName},'%')
                </if>
                <if test="agencyNo != null and agencyNo != ''">
                 	AND 	b.agency_no = #{agencyNo}
                </if>
                <if test="groupSeq != null and groupSeq != ''">
                 	AND 	b.group_seq = #{groupSeq}
                </if>
					) a
					LEFT OUTER JOIN (	SELECT	a.*
											FROM		bcg a
							      				, (
														SELECT  mat_id, MAX(bno) bno
														FROM   bcg a
														WHERE   1=1
														AND  DATE_FORMAT(a.reg_date, '%Y%m%d%H%i') >= DATE_FORMAT(date_add(NOW(),INTERVAL -5 minute), '%Y%m%d%H%i')
														GROUP BY mat_id
														) b
											WHERE    1=1
											AND      a.mat_id = b.mat_id
											AND      a.bno = b.bno
										  ) b
		      	ON	a.mat_id = b.mat_id
		       LEFT OUTER join tbl_agency c
		       ON	a.agency_no = c.agency_no
	</select>

	<select id="selectSummaryTotalCountP" resultType="int">
		SELECT		COUNT(*) cnt
		FROM   tbl_member a
		       LEFT OUTER join bcg b
		       ON	a.mat_id = b.mat_id
		       AND  DATE_FORMAT(b.reg_date, '%Y%m%d%H%i') >= DATE_FORMAT(date_add(NOW(),INTERVAL -5 minute), '%Y%m%d%H%i')
		       LEFT OUTER join tbl_agency c
		       ON	a.agency_no = c.agency_no
		     , tbl_mat_info d
		       left outer join tbl_agency_group e
		       on  d.group_seq = e.group_seq
		WHERE  1=1
		and	   a.userid = #{userId}
		and    a.mat_id = d.mat_id
		ORDER BY b.reg_date desc
		LIMIT 1
	</select>

	<select id="selectMenuSummaryListA" resultType="com.ltop.app.common.domain.UserVO">
		<![CDATA[
			SELECT R.*
			FROM
			(
				SELECT a.userid
				      , a.username
				      , c.agency_name AS agencyName
				      , a.group_name AS groupName
						, b.mat_id  AS matId
						, b.respiration_rate  AS respirationRate
						, b.heart_rate AS heartRate
						, b.sleep_mode  AS sleepMode
				       , ( select case when count(1) > 0 then '낙상감지' else '감시중' end from mat_alarm ta where 1=1 and ta.event_num='30001'  and ta.mat_id = b.mat_id  AND    DATE_FORMAT(ta.reg_date, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d') ) fallAlarm
				FROM		(
							SELECT	c.userid, c.username, c.mat_id, c.agency_no, d.group_name
							FROM		tbl_mat_info b
							         left outer join tbl_agency_group d
							         on b.group_seq = d.group_seq
							       , tbl_member c
							WHERE    1=1
							AND      b.use_yn = 'Y'
							AND      b.mat_id = c.mat_id
		]]>
                <if test="alarmVO.searchUserName != null and alarmVO.searchUserName != ''">
                 	AND 	c.username LIKE CONCAT('%',#{alarmVO.searchUserName},'%')
                </if>
                <if test="alarmVO.agencyNo != null and alarmVO.agencyNo != ''">
                 	AND 	b.agency_no = #{alarmVO.agencyNo}
                </if>
                <if test="alarmVO.groupSeq != null and alarmVO.groupSeq != ''">
                 	AND 	b.group_seq = #{alarmVO.groupSeq}
                </if>
		<![CDATA[
							) a
							LEFT OUTER JOIN (	SELECT	a.*
													FROM		bcg a
									      				, (
																SELECT  mat_id, MAX(bno) bno
																FROM   bcg a
																WHERE   1=1
																AND  DATE_FORMAT(a.reg_date, '%Y%m%d%H%i') >= DATE_FORMAT(date_add(NOW(),INTERVAL -5 minute), '%Y%m%d%H%i')
																GROUP BY mat_id
																) b
													WHERE    1=1
													AND      a.mat_id = b.mat_id
													AND      a.bno = b.bno
												  ) b
				      	ON	a.mat_id = b.mat_id
				       LEFT OUTER join tbl_agency c
				       ON	a.agency_no = c.agency_no
		]]>

		<![CDATA[
			) R
			ORDER BY R.agencyName, R.groupName ASC
			LIMIT #{pageVO.amount} OFFSET #{pageVO.startNum}
		]]>
	</select>

	<select id="selectMenuSummaryListU" resultType="com.ltop.app.common.domain.UserVO">
		<![CDATA[
			SELECT R.*
			FROM
			(
				SELECT a.userid
				      , a.username
				      , c.agency_name AS agencyName
				      , a.group_name AS groupName
						, b.mat_id AS matId
						, b.respiration_rate AS respirationRate
						, b.heart_rate AS heartRate
						, b.sleep_mode  AS sleepMode
				      , ( select case when count(1) > 0 then '낙상감지' else '감시중' end from mat_alarm ta where 1=1 and ta.event_num='30001'  and ta.mat_id = b.mat_id  AND    DATE_FORMAT(ta.reg_date, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d') ) fallAlarm
				FROM		(
							SELECT	c.userid, c.username, c.mat_id, c.agency_no, d.group_name
							FROM		tbl_agency a
							       , tbl_mat_info b
							         left outer join tbl_agency_group d
							         on b.group_seq = d.group_seq
							       , tbl_member c
							WHERE    1=1
							AND      a.adm_id =#{alarmVO.userId}
							AND      a.agency_no = b.agency_no
							AND      a.use_yn = 'Y'
							AND      b.use_yn = 'Y'
							AND      b.mat_id = c.mat_id
		]]>
                <if test="alarmVO.searchUserName != null and alarmVO.searchUserName != ''">
                 	AND 	c.username LIKE CONCAT('%',#{alarmVO.searchUserName},'%')
                </if>
                <if test="alarmVO.agencyNo != null and alarmVO.agencyNo != ''">
                 	AND 	b.agency_no = #{alarmVO.agencyNo}
                </if>
                <if test="alarmVO.groupSeq != null and alarmVO.groupSeq != ''">
                 	AND 	b.group_seq = #{alarmVO.groupSeq}
                </if>
		<![CDATA[
							) a
							LEFT OUTER JOIN (	SELECT	a.*
													FROM		bcg a
									      				, (
																SELECT  mat_id, MAX(bno) bno
																FROM   bcg a
																WHERE   1=1
																AND  DATE_FORMAT(a.reg_date, '%Y%m%d%H%i') >= DATE_FORMAT(date_add(NOW(),INTERVAL -5 minute), '%Y%m%d%H%i')
																GROUP BY mat_id
																) b
													WHERE    1=1
													AND      a.mat_id = b.mat_id
													AND      a.bno = b.bno
												  ) b
				      	ON	a.mat_id = b.mat_id
				       LEFT OUTER join tbl_agency c
				       ON	a.agency_no = c.agency_no
		]]>

		<![CDATA[
			) R
			ORDER BY R.agencyName, R.groupName ASC
			LIMIT #{pageVO.amount} OFFSET #{pageVO.startNum}
		]]>
	</select>

	<select id="selectMenuSummaryListP" resultType="com.ltop.app.common.domain.UserVO">
		<![CDATA[
			SELECT R.*
			FROM
			(
				SELECT a.userid
				      , a.username
				      , c.agency_name AS agencyName
				      , e.group_name AS groupName
				      , b.mat_id AS matId
						, b.respiration_rate AS respirationRate
						, b.heart_rate AS heartRate
						, b.sleep_mode  AS sleepMode
					  , ( select case when count(1) > 0 then '낙상감지' else '감시중' end from mat_alarm ta where 1=1 and ta.event_num='30001'  and ta.mat_id = b.mat_id  AND    DATE_FORMAT(ta.reg_date, '%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d') ) fallAlarm
				FROM   tbl_member a
				       LEFT OUTER join bcg b
				       ON	a.mat_id = b.mat_id
				       AND  DATE_FORMAT(b.reg_date, '%Y%m%d%H%i') >= DATE_FORMAT(date_add(NOW(),INTERVAL -5 minute), '%Y%m%d%H%i')
				       LEFT OUTER join tbl_agency c
				       ON	a.agency_no = c.agency_no
				     , tbl_mat_info d
				       left outer join tbl_agency_group e
				       on  d.group_seq = e.group_seq
				WHERE  1=1
				and	   a.userid = #{alarmVO.userId}
				and    a.mat_id = d.mat_id
				ORDER BY b.reg_date desc
				LIMIT 1
		]]>

		<![CDATA[
			) R
			ORDER BY R.agencyName, R.groupName ASC
			LIMIT #{pageVO.amount} OFFSET #{pageVO.startNum}
		]]>
	</select>

    <select id="bcgList" resultType="com.ltop.app.common.domain.BcgVO">
		select  a.bno
		      , a.respiration_rate as respirationRate
		      , a.heart_rate as heartRate
		      , a.sleep_mode as sleepMode
		      , DATE_FORMAT(a.reg_date, '%Y-%m-%d %h:%i') as regDate
		from	bcg a 
		      , tbl_member b
		where	1=1
		and    	b.userid = #{userId}
		and    	a.mat_id = b.mat_id
		<if test="searchDateFrom != null and searchDateFrom != ''">
		AND 	DATE_FORMAT(a.reg_date, '%Y-%m-%d') = #{searchDateFrom}
		</if>
		order by a.bno asc
    </select>
</mapper>